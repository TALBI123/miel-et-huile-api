generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
  directUrl    = env("DIRECT_URL")
  relationMode = "prisma"
}

model User {
  id                String               @id @default(dbgenerated("gen_random_uuid()"))
  firstName         String
  lastName          String
  email             String               @unique
  password          String?
  phoneNumber       String?
  city              String?
  state             String?
  postalCode        String?
  country           String?
  newsletter        Boolean              @default(false)
  termsAccepted     Boolean              @default(false)
  isVerified        Boolean              @default(false)
  role              Role                 @default(USER)
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  address           String?
  image             String?
  publicId          String?              @unique
  googleId          String?              @unique
  order             Order[]
  review            Review[]
  verificationToken VerificationTokens[]
  Dispute           Dispute[]

  @@index([createdAt])
  @@index([email])
  @@index([isVerified])
}

enum Role {
  USER
  ADMIN
}

model Category {
  id          String    @id @default(dbgenerated("gen_random_uuid()"))
  name        String    @unique
  image       String
  publicId    String
  createdAt   DateTime  @default(now())
  description String?
  slug        String    @unique
  updatedAt   DateTime  @updatedAt
  isActive    Boolean   @default(false)
  products    Product[]
  Banner      Banner[]

  @@index([isActive])
}

model Product {
  id             String           @id @default(dbgenerated("gen_random_uuid()"))
  categoryId     String
  createdAt      DateTime         @default(now())
  description    String
  updatedAt      DateTime         @updatedAt
  title          String
  rating         Float?           @default(0)
  subDescription String           @default("")
  isActive       Boolean          @default(false)
  origin         String? // "Maroc", "Alg√©rie", etc.
  productType    ProductType      @default(HONEY)
  category       Category         @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  review         Review[]
  orderItems     OrderItem[]
  images         ProductImage[]
  variants       ProductVariant[]
  Banner         Banner[]
  ProductDetails ProductDetails?
  PackItem       PackItem[]

  @@index([categoryId])
  @@index([createdAt])
  @@index([isActive])
  @@index([categoryId, isActive, productType])
  @@index([createdAt, isActive])
  @@index([rating, isActive]) // Pour le tri par popularit√©
}

model ProductDetails {
  id             String  @id @default(cuid())
  productId      String  @unique
  product        Product @relation(fields: [productId], references: [id])
  jsonAttributes Json?
}

model ProductImage {
  id        String  @id @default(dbgenerated("gen_random_uuid()"))
  image     String
  publicId  String
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model ProductVariant {
  id            String @id @default(dbgenerated("gen_random_uuid()"))
  price         Float
  discountPrice Float? @default(0)

  discountPercentage Int?     @default(0)
  isOnSale           Boolean? @default(false)
  stock              Int      @default(0)
  productId          String
  isActive           Boolean  @default(true)
  unit               String?
  amount             Float?
  size               String?

  // üÜï NOUVEAU : Attributs sp√©cifiques miel/dattes
  name      String
  sku       String      @unique
  product   Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  OrderItem OrderItem[]

  @@unique([amount, productId])
  @@unique([size, productId])
  @@index([productId])
  @@index([isActive])
  @@index([isOnSale])
  @@index([sku]) // üÜï Index SKU
}

enum ProductType {
  HONEY // Miel
  CLOTHING // V√™tements
  DATES // Dattes
}

model Order {
  id                    String         @id @default(dbgenerated("gen_random_uuid()"))
  userId                String
  totalAmount           Float
  status                OrderStatus    @default(PENDING)
  paymentStatus         PaymentStatus  @default(PENDING)
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  stripePaymentIntentId String?        @unique
  stripeSessionId       String?        @unique
  paymentMethod         PaymentMethod? @default(CARD)
  notes                 String?
  user                  User           @relation(fields: [userId], references: [id])
  items                 OrderItem[]
  Dispute               Dispute[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([paymentStatus])
  @@index([stripeSessionId])
}

enum OrderStatus {
  PENDING
  PROCESSING
  CONFIRMED
  SHIPPED
  DELIVERED
  ON_HOLD
  CANCELLED
  REFUNDED
  RESOLVED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  PROCESSING
  REQUIRES_ACTION
  DISPUTED
  EXPIRED
}

enum PaymentMethod {
  CARD
  PAYPAL
  APPLE_PAY
  GOOGLE_PAY
  BANCONTACT
  IDEAL
  SOFORT
  SEPA_DEBIT
  GIROPAY
  KLARNA
  AFTERPAY
}

model OrderItem {
  id        String         @id @default(dbgenerated("gen_random_uuid()"))
  orderId   String
  productId String
  quantity  Int            @default(1)
  price     Float
  variantId String
  order     Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product        @relation(fields: [productId], references: [id])
  variant   ProductVariant @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([productId])
}

model Review {
  id         String   @id @default(dbgenerated("gen_random_uuid()"))
  productId  String
  userId     String
  rating     Int
  title      String?
  comment    String?
  isVerified Boolean  @default(false)
  isApproved Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  product    Product  @relation(fields: [productId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@unique([productId, userId])
  @@index([productId])
  @@index([userId])
  @@index([rating])
  @@index([isApproved])
  @@index([productId, isApproved, rating]) // Filtrage avis
  @@index([createdAt, isApproved]) // Pagination admin
}

model Promotion {
  id             String       @id @default(dbgenerated("gen_random_uuid()"))
  code           String       @unique
  discountType   DiscountType @default(PERCENTAGE)
  discountValue  Float
  minOrderAmount Float?
  maxUses        Int?
  usedCount      Int          @default(0)
  validFrom      DateTime
  validUntil     DateTime
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())

  @@index([isActive])
  @@index([validUntil])
}

model Testimonial {
  id         String   @id @default(dbgenerated("gen_random_uuid()"))
  clientName String
  image      String?
  publicId   String?
  content    String
  rating     Int
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([isActive])
}

model ShippingZone {
  id        String   @id @default(dbgenerated("gen_random_uuid()"))
  name      String
  countries String[]
  price     Float
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([createdAt])
  @@index([isActive])
}

model NewsletterSubscription {
  id        String   @id @default(uuid())
  email     String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([isActive])
}

model VerificationTokens {
  id        String                @id @default(dbgenerated("gen_random_uuid()"))
  token     String                @unique
  userId    String
  type      VerificationTokenType
  expiresAt DateTime
  createdAt DateTime              @default(now())
  user      User                  @relation(fields: [userId], references: [id])

  @@index([userId, type])
}

enum VerificationTokenType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
}

/// schema.prisma
model Pack {
  id          String   @id @default(dbgenerated("gen_random_uuid()"))
  title       String
  slug        String   @unique
  description String?
  price       Float
  discount    Float?   @default(0.0)
  isActive    Boolean  @default(false)
  stock       Int      @default(0)
  image       String?
  publicId    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // relation many-to-many avec Product (table join PackItem)
  items PackItem[]

  // relation inverse depuis Banner
  banners Banner[]

  @@index([isActive])
  @@index([price])
  @@index([createdAt])
  @@index([slug, isActive])
}

model PackItem {
  id        String @id @default(dbgenerated("gen_random_uuid()"))
  packId    String
  productId String
  qty       Int    @default(1)
  unitPrice Float

  pack    Pack    @relation(fields: [packId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@unique([packId, productId]) // √©vite doublons produit dans un m√™me pack
  @@index([packId])
  @@index([productId])
}

model Banner {
  id           String         @id @default(dbgenerated("gen_random_uuid()"))
  title        String
  text         String?
  buttonText   String?
  desktopImage String
  desktopPublicId String
  mobileImage  String?
  mobilePublicId String?
  publicId     String
  linkType     BannerLinkType @default(NONE)
  productId    String?
  categoryId   String?
  packId       String? // üî• nouveau champ
  customUrl    String?

  type      BannerType @default(GENERAL)
  order     Int        @default(0)
  isActive  Boolean    @default(false)
  startsAt  DateTime?
  endsAt    DateTime?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  product  Product?  @relation(fields: [productId], references: [id])
  category Category? @relation(fields: [categoryId], references: [id])
  pack     Pack?     @relation(fields: [packId], references: [id])
  // ‚úÖ Exemple d'index composite utile pour les filtres combin√©s

  // ‚öôÔ∏è Index pour am√©liorer les performances des requ√™tes
  @@index([isActive])
  @@index([type])
  @@index([startsAt])
  @@index([endsAt])
  @@index([order])
  @@index([productId])
  @@index([categoryId])
  @@index([packId])
}

enum BannerLinkType {
  NONE
  CATEGORY
  PRODUCT
  PACK
}

enum BannerType {
  GENERAL
  PROMOTION
  EVENT
  ANNOUNCEMENT
  // PARTNER
  FLASH_SALE
}

model Alert {
  id               String        @id @default(dbgenerated("gen_random_uuid()"))
  type             AlertType
  message          String
  entityType       String // ex: "ORDER", "CATEGORY", "PRODUCT"
  entityId         String?
  severity         AlertSeverity @default(INFO)
  severityRank     Int // pour faciliter le tri par s√©v√©rit√©
  resolved         Boolean       @default(false)
  occurrences      Int           @default(1)
  lastOccurrenceAt DateTime?     @default(now()) // date de la derni√®re occurrence
  deduplicationKey String? // cl√© pour √©viter doublons
  slaDeadline      DateTime?
  createdAt        DateTime      @default(now())
  resolvedAt       DateTime?
  status           AlertStatus   @default(ACTIVE)
  tags             AlertTag[]    @default([])

  // Mini log interne
  lastAction   String? // CREATED, UPDATED, ESCALATED, RESOLVED
  lastActionAt DateTime? // date du dernier changement
  lastNotes    String? // courte note ou explication

  @@index([status])
  @@index([severity])
  @@index([entityType, entityId])
  @@index([deduplicationKey])
}

enum AlertTag {
  // Litiges
  DISPUTE_WON
  DISPUTE_LOST

  // Produits
  LOW_STOCK
  OUT_OF_STOCK

  // S√©curit√© / serveur
  SECURITY_BREACH_ATTEMPT
  SLA_24H

  // Priorit√© / notifications
  URGENT
  NOTIFY_ADMIN
}

enum AlertType {
  // Litiges / paiements
  DISPUTE_CREATED
  DISPUTE_UPDATED
  DISPUTE_CLOSED
  DISPUTE_ERROR
  PAYMENT_FAILED

  // Inventaire / produits
  STOCK_ISSUE

  // Syst√®me / serveur / s√©curit√©
  SYSTEM_ERROR
  SERVER_ERROR
}

enum AlertStatus {
  ACTIVE // L‚Äôalerte est en cours
  RESOLVED // L‚Äôalerte a √©t√© trait√©e
  ESCALATED // Escalade d√©clench√©e (SLA d√©pass√©)
}

enum AlertSeverity {
  INFO
  WARNING
  CRITICAL
  URGENT
}

model Dispute {
  id       String  @id @default(cuid())
  stripeId String? @unique // chaque litige Stripe est unique
  orderId  String
  order    Order   @relation(fields: [orderId], references: [id])
  userId   String
  user     User    @relation(fields: [userId], references: [id])

  // --- √âtat du litige ---
  status       String // "pending", "under_review", "submitted", "won", "lost"
  stripeStatus String? // statut Stripe (needs_response, under_review, won, lost)

  // --- Gestion interne ---
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  reviewedBy    String? // Admin qui a valid√© le dossier
  reviewedAt    DateTime?
  autoSubmitted Boolean   @default(false)

  // --- Preuves ---
  pdfProofUrl     String? // lien vers le PDF g√©n√©r√©
  deliveryProof   String? // URL capture de livraison ou autre
  customerEmail   String?
  productDesc     String?
  additionalNotes String?

  // --- Logs / audit ---
  logs Json?

  // === Indexes ===
  @@index([orderId])
  @@index([userId])
  @@index([status])
  @@index([stripeStatus])
  @@index([createdAt])
  @@index([reviewedBy])
  @@index([customerEmail])
  @@index([orderId, userId])
  @@index([status, stripeStatus])
  @@index([createdAt, status])
}

enum DiscountType {
  PERCENTAGE
  FIXED
}
